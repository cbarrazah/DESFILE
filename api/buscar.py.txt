import json
import pandas as pd
import requests

def handler(request):
    try:
        cedula = request.get("query", {}).get("cedula", None)
        if not cedula:
            return {
                "statusCode": 400,
                "body": json.dumps({"error": "Debe enviar ?cedula=XXXX"})
            }

        # TU ARCHIVO REAL (RAW)
        EXCEL_URL = "https://raw.githubusercontent.com/cbarrazah/DESFILE/bcd3a46d43282efde9de715ee0a4bf4618cf7ff3/LISTADO.xlsx"

        # DESCARGAR EXCEL
        resp = requests.get(EXCEL_URL)
        if resp.status_code != 200:
            return {
                "statusCode": 500,
                "body": json.dumps({"error": "No se pudo descargar el Excel"})
            }

        # GUARDAR EN /tmp (OBLIGATORIO EN VERCEL)
        temp_path = "/tmp/listado.xlsx"
        with open(temp_path, "wb") as f:
            f.write(resp.content)

        # LEER EXCEL
        df = pd.read_excel(temp_path)

        # Asegurar que la columna exista
        if "CEDULA" not in df.columns:
            return {
                "statusCode": 500,
                "body": json.dumps({"error": "La columna 'CEDULA' no existe en el Excel"})
            }

        # BUSCAR FILA
        resultado = df[df["CEDULA"].astype(str) == str(cedula)]

        if resultado.empty:
            return {
                "statusCode": 404,
                "body": json.dumps({"error": "No encontrado"})
            }

        data = resultado.to_dict(orient="records")[0]

        return {
            "statusCode": 200,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps(data, ensure_ascii=False)
        }

    except Exception as e:
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)})
        }
